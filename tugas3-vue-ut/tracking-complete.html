<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tracking Delivery Order - SITTA UT</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <div id="app">
    <header>
      <h1>ðŸšš Tracking Delivery Order</h1>
      <nav>
        <a href="index.html">Beranda</a> | 
        <a href="stok-complete.html">Stok Bahan Ajar</a>
      </nav>
    </header>

    <!-- Komponen Form DO Baru -->
    <do-form
      v-if="showForm"
      :pengiriman-list="pengirimanList"
      :paket="paket"
      :next-nomor-d-o="nextNomorDO"
      @add-do="handleAddDO"
      @cancel="cancelForm">
    </do-form>

    <button v-else @click="showForm = true" class="btn-add">
      + Buat DO Baru
    </button>

    <!-- Komponen Tracking DO -->
    <do-tracking
      :tracking="tracking"
      @add-progress="handleAddProgress">
    </do-tracking>

    <footer>
      <p>Total DO: {{ Object.keys(tracking).length }}</p>
    </footer>
  </div>

  <!-- TEMPLATES -->
  <!-- Template: DO Form -->
  <script type="text/x-template" id="tpl-do-form">
    <div class="form-section">
      <h3>Tambah Delivery Order Baru</h3>
      
      <form @submit.prevent="submitForm" @keydown="handleKeydown">
        <div class="form-grid">
          <div class="form-group">
            <label>Nomor DO:</label>
            <input v-model="formData.nomorDO" disabled>
          </div>

          <div class="form-group">
            <label>NIM:</label>
            <input v-model="formData.nim" placeholder="Masukkan NIM" required>
          </div>

          <div class="form-group">
            <label>Nama:</label>
            <input v-model="formData.nama" placeholder="Masukkan Nama" required>
          </div>

          <div class="form-group">
            <label>Ekspedisi:</label>
            <select v-model="formData.ekspedisi" required>
              <option value="">Pilih Ekspedisi</option>
              <option v-for="e in pengirimanList" :key="e.kode" :value="e.kode">
                {{ e.nama }}
              </option>
            </select>
          </div>

          <div class="form-group">
            <label>Paket Bahan Ajar:</label>
            <select v-model="formData.paketKode" required>
              <option value="">Pilih Paket</option>
              <option v-for="p in paket" :key="p.kode" :value="p.kode">
                {{ p.kode }} - {{ p.nama }}
              </option>
            </select>
          </div>

          <div class="form-group" v-if="selectedPaket">
            <label>Detail Paket:</label>
            <div class="paket-detail">
              <p><strong>{{ selectedPaket.nama }}</strong></p>
              <p>Isi: {{ selectedPaket.isi.join(', ') }}</p>
              <p>Harga: {{ selectedPaket.harga | currency }}</p>
            </div>
          </div>

          <div class="form-group">
            <label>Tanggal Kirim:</label>
            <input v-model="formData.tanggalKirim" type="date" required>
          </div>

          <div class="form-group">
            <label>Total Harga:</label>
            <input :value="formData.total | currency" disabled>
          </div>
        </div>

        <div class="form-buttons">
          <button type="submit" class="btn-primary">Simpan DO</button>
          <button type="button" @click="cancel" class="btn-secondary">Batal</button>
        </div>
        
        <p style="font-size: 12px; color: #666; margin-top: 10px;">
          * Tekan Enter untuk menyimpan
        </p>
      </form>
    </div>
  </script>

  <!-- Template: DO Tracking -->
  <script type="text/x-template" id="tpl-do-tracking">
    <div class="tracking-section">
      <h3>Pencarian Delivery Order</h3>
      
      <div class="filter-section" style="margin-bottom: 20px;">
        <div class="filter-row">
          <label>Cari berdasarkan:</label>
          <select v-model="searchType">
            <option value="noDO">Nomor DO</option>
            <option value="nim">NIM</option>
          </select>
          <input 
            v-model="searchQuery" 
            :placeholder="searchType === 'noDO' ? 'Masukkan Nomor DO' : 'Masukkan NIM'"
            @keydown="handleKeydown"
            style="margin-left: 10px; padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; min-width: 250px;">
        </div>
        <p style="font-size: 12px; color: #666; margin-top: 10px;">
          * Tekan Enter untuk mencari, ESC untuk reset
        </p>
      </div>
      
      <h3>Daftar Delivery Order</h3>
      
      <div v-if="Object.keys(filteredTracking).length === 0" class="no-data">
        {{ searchQuery ? 'Tidak ditemukan data yang cocok' : 'Belum ada data delivery order' }}
      </div>

      <div v-for="(do_item, noDO) in filteredTracking" :key="noDO" class="do-card">
        <div class="do-header">
          <h4>{{ noDO }}</h4>
          <span :class="'status-badge status-' + getStatusClass(do_item.status)">
            {{ do_item.status }}
          </span>
        </div>

        <div class="do-info">
          <div class="info-row">
            <span class="label">NIM:</span>
            <span>{{ do_item.nim }}</span>
          </div>
          <div class="info-row">
            <span class="label">Nama:</span>
            <span>{{ do_item.nama }}</span>
          </div>
          <div class="info-row">
            <span class="label">Ekspedisi:</span>
            <span>{{ do_item.ekspedisi }}</span>
          </div>
          <div class="info-row">
            <span class="label">Paket:</span>
            <span>{{ do_item.paket }}</span>
          </div>
          <div class="info-row">
            <span class="label">Tanggal Kirim:</span>
            <span>{{ do_item.tanggalKirim | formatDate }}</span>
          </div>
          <div class="info-row">
            <span class="label">Total:</span>
            <span>{{ do_item.total | currency }}</span>
          </div>
        </div>

        <div class="tracking-timeline" v-if="do_item.perjalanan">
          <h5>Timeline Pengiriman:</h5>
          <div v-for="(step, index) in do_item.perjalanan" :key="index" class="timeline-item">
            <div class="timeline-dot"></div>
            <div class="timeline-content">
              <span class="timeline-time">{{ step.waktu }}</span>
              <p>{{ step.keterangan }}</p>
            </div>
          </div>
          
          <button @click="addProgress(noDO)" class="btn-add" style="margin-top: 10px;">
            + Tambah Progress
          </button>
        </div>
      </div>
    </div>
  </script>

  <!-- Vue.js -->
  <script src="https://cdn.jsdelivr.net/npm/vue@2.7.14/dist/vue.js"></script>
  
  <!-- Services -->
  <script src="js/services/api.js"></script>
  
  <!-- Components -->
  <script src="js/components/do-form.js"></script>
  <script src="js/components/do-tracking.js"></script>
  
  <!-- App -->
  <script src="js/app-tracking.js"></script>
</body>
</html>
